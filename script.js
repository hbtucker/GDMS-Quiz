const quizData = [
  {
    "id": 1,
    "text": "I make sure that I have all the facts before I make a decision.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "A"
  },
  {
    "id": 2,
    "text": "When I make a decision I do what feels right.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "B"
  },
  {
    "id": 3,
    "text": "I often ask other people to help me make important decisions.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "C"
  },
  {
    "id": 4,
    "text": "I don't like making decisions, so I try to avoid it.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "D"
  },
  {
    "id": 5,
    "text": "I make decisions quickly.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "E"
  },
  {
    "id": 6,
    "text": "I make decisions in a slow, logical way.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "A"
  },
  {
    "id": 7,
    "text": "When I make a decision I rely on my instincts.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "B"
  },
  {
    "id": 8,
    "text": "I don't make big decisions without talking to other people first.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "C"
  },
  {
    "id": 9,
    "text": "I usually won't make an important decision until I'm forced to do so.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "D"
  },
  {
    "id": 10,
    "text": "I don't think too much about the decisions that I make.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "E"
  },
  {
    "id": 11,
    "text": "Making decisions requires careful thought.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "A"
  },
  {
    "id": 12,
    "text": "A decision doesn't need to make sense. It just needs to feel right.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "B"
  },
  {
    "id": 13,
    "text": "When I need to make an important decision, I like to have someone point me in the right direction.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "C"
  },
  {
    "id": 14,
    "text": "I try to put off making important decisions because thinking about them makes me feel uneasy.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "D"
  },
  {
    "id": 15,
    "text": "When I need to make an important decision I just do what seems natural at the moment.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "E"
  },
  {
    "id": 16,
    "text": "I consider all of my options before making a decision.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "A"
  },
  {
    "id": 17,
    "text": "I rely on my inner feelings when making decisions.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "B"
  },
  {
    "id": 18,
    "text": "When I make a decision, I rely on other people's advice.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "C"
  },
  {
    "id": 19,
    "text": "I usually make important decisions at the last minute.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "D"
  },
  {
    "id": 20,
    "text": "I often make impulsive decisions.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "E"
  }
];

const weightings = {
  "A": "Systemic",
  "B": "Intuitive",
  "C": "Dependent",
  "D": "Avoidant",
  "E": "Spontaneous"
};

let currentQuestion = 0;
let scores = { Systemic: 0, Intuitive: 0, Dependent: 0, Avoidant: 0, Spontaneous: 0 };
let userAnswers = [];

const startPageEl = document.getElementById("start-page");
const startQuizBtn = document.getElementById("start-quiz");
const questionEl = document.getElementById("question");
const choicesEl = document.getElementById("choices");
const quizEl = document.getElementById("quiz");
const resultsEl = document.getElementById("results");
const restartBtn = document.getElementById("restart");
const downloadPDFBtn = document.getElementById("downloadPDF");
const progressBarEl = document.getElementById("progress-bar");
const progressTextEl = document.getElementById("progress-text");

startQuizBtn.addEventListener("click", startQuiz);

function startQuiz() {
  startPageEl.style.display = "none";
  quizEl.style.display = "block";
  loadQuestion();
}

function loadQuestion() {
  if (currentQuestion < quizData.length) {
    const question = quizData[currentQuestion];
    questionEl.textContent = question.text;

    choicesEl.innerHTML = "";
    question.options.forEach((option, index) => {
      const button = document.createElement("button");
      button.textContent = option.text;
      button.addEventListener("click", () => selectChoice(index));
      choicesEl.appendChild(button);
    });

    updateProgressBar();
  } else {
    showResults();
  }
}

function selectChoice(index) {
  const question = quizData[currentQuestion];
  const selectedOption = question.options[index];

  scores[weightings[question.weighting]] += selectedOption.value;
  userAnswers.push(index);

  currentQuestion++;
  loadQuestion();
}

function updateProgressBar() {
  const progress = (currentQuestion / quizData.length) * 100;
  progressBarEl.style.width = `${progress}%`;
  progressTextEl.textContent = `Question ${currentQuestion + 1} of ${quizData.length}`;
}

function showResults() {
  quizEl.style.display = "none";
  resultsEl.style.display = "block";

  const categories = Object.keys(scores);
  const maxScore = 12 * 3; // 4 questions per category, max value of 3 per question
  const categoryScores = categories.map(category => (scores[category] / maxScore) * 100);

  const ctx = document.getElementById('polarChart').getContext('2d');
  new Chart(ctx, {
    type: 'polarArea',
    data: {
      labels: categories,
      datasets: [{
        label: 'Your General Decision Making Style',
        data: categoryScores,
        backgroundColor: [
          'rgba(255, 99, 132, 0.5)',
          'rgba(54, 162, 235, 0.5)',
          'rgba(255, 206, 86, 0.5)',
          'rgba(75, 192, 192, 0.5)',
          'rgba(153, 102, 255, 0.5)'
        ],
        borderColor: [
          'rgba(255, 99, 132, 1)',
          'rgba(54, 162, 235, 1)',
          'rgba(255, 206, 86, 1)',
          'rgba(75, 192, 192, 1)',
          'rgba(153, 102, 255, 1)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        r: {
          pointLabels: {
            display: true,
            centerPointLabels: true,
            font: {
              size: 18
            }
          }
        }
      },
      plugins: {
        legend: {
          position: 'top',
        },
      }
    }
  });
}

function restartQuiz() {
  currentQuestion = 0;
  scores = { Systemic: 0, Intuitive: 0, Dependent: 0, Avoidant: 0, Spontaneous: 0 };
  userAnswers = [];
  resultsEl.style.display = "none";
  startPageEl.style.display = "block";
}

function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Add Manrope font
  doc.addFont('https://fonts.gstatic.com/s/manrope/v20/pxiByp8kv8JHgFVrLDz8V1tvFP-KUEg.ttf', 'Manrope', 'normal');
  doc.addFont('https://fonts.gstatic.com/s/manrope/v20/pxiByp8kv8JHgFVrLGT9V1tvFP-KUEg.ttf', 'Manrope', 'bold');
  doc.setFont('Manrope');

  // Add logo to the PDF
  const logoImg = new Image();
  logoImg.src = 'logo.png';
  logoImg.onload = function() {
    const imgWidth = 30;
    const imgHeight = (logoImg.height * imgWidth) / logoImg.width;
    const pageWidth = doc.internal.pageSize.getWidth();
    doc.addImage(logoImg, 'PNG', pageWidth - imgWidth - 10, 10, imgWidth, imgHeight);

    doc.setFontSize(20);
    doc.setFont('Manrope', 'bold');
    doc.text("Decision Making Style Results", 105, 25, null, null, "center");

    doc.setFontSize(12);
    doc.setFont('Manrope', 'bold');
    let yPos = 40;
    doc.text("Your Decision Style Profile", 20, yPos);
    yPos += 10;

    const categories = Object.keys(scores);
    const maxScore = 12 * 3; // 4 questions per category, max value of 3 per question

    categories.forEach(category => {
      const score = (scores[category] / maxScore) * 100;
      doc.text(`${category}: ${score.toFixed(0)}%`, 30, yPos);
      yPos += 10;
    });

    yPos += 10;
    doc.setFont('Manrope', 'bold');
    doc.text("Decision Style Descriptions", 20, yPos);
    yPos += 10;
    doc.setFont('Manrope', 'normal');
    doc.setFontSize(12);
    const additionalText = [
      "This quiz assesses your general decision making style based on the standardised GDMS survey.",
      "Systemic style: Systemic or rational decision makers tend to make decisions slowly and carefully, ensuring they have all the facts before proceeding. This style emphasises searching and evaluating alternatives.",
      "Intuitive style: When making a decision, you tend to rely on your feelings. Intuitive decision making emphasises a reliance on hunches and instinct.",
      "Dependent style: May find it hard to make decisions without other people's support. Dependent decision making emphasises a search for advice and direction from others.",
      "Avoidant style: Tends to dislike making important decisions, making you feel uneasy and uncomfortable. Avoidant decision making emphasises postponing and avoiding decisions.",
      "Spontaneous style: Able to make important decisions quickly and easily, often based on impulses. This style emphasises a sense of immediacy and a desire to get through the decision-making process as soon as possible.",
      "If you have equally high scores in more than one area, it means that you regularly use more than one decision-making style. Skilled decision-makers are able to use more than one style and in real life most of us do. They're able to be flexible and use the style that best fits the situation.",
      "Your results are visualized in the polar chart on the next page.",
    ];
    additionalText.forEach(text => {
      doc.text(text, 20, yPos, { maxWidth: 170 });
      yPos += doc.getTextDimensions(text, { maxWidth: 170 }).h + 2;
    });

    html2canvas(document.getElementById("polarChart")).then(canvas => {
      const imgData = canvas.toDataURL("image/png");
      const imgWidth = 150;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      doc.addPage();
      doc.addImage(imgData, "PNG", 15, 20, imgWidth, imgHeight);
      doc.save("GDMS_Results.pdf");

      notifyPDFDownload();
    });
  };
}

function notifyPDFDownload() {
  console.log("Notifying harry@culture-coach.org about PDF download");
  // In a real-world scenario, you would implement an API call here
}

restartBtn.addEventListener("click", restartQuiz);
downloadPDFBtn.addEventListener("click", generatePDF);
