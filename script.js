const quizData = [
  {
    "id": 1,
    "text": "I make sure that I have all the facts before I make a decision.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "A"
  },
  {
    "id": 2,
    "text": "When I make a decision I do what feels right.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "B"
  },
  {
    "id": 3,
    "text": "I often ask other people to help me make important decisions.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "C"
  },
  {
    "id": 4,
    "text": "I don't like making decisions, so I try to avoid it.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "D"
  },
  {
    "id": 5,
    "text": "I make decisions quickly.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "E"
  },
  {
    "id": 6,
    "text": "I make decisions in a slow, logical way.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "A"
  },
  {
    "id": 7,
    "text": "When I make a decision I rely on my instincts.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "B"
  },
  {
    "id": 8,
    "text": "I don't make big decisions without talking to other people first.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "C"
  },
  {
    "id": 9,
    "text": "I usually won't make an important decision until I'm forced to do so.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "D"
  },
  {
    "id": 10,
    "text": "I don't think too much about the decisions that I make.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "E"
  },
  {
    "id": 11,
    "text": "Making decisions requires careful thought.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "A"
  },
  {
    "id": 12,
    "text": "A decision doesn't need to make sense. It just needs to feel right.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "B"
  },
  {
    "id": 13,
    "text": "When I need to make an important decision, I like to have someone point me in the right direction.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "C"
  },
  {
    "id": 14,
    "text": "I try to put off making important decisions because thinking about them makes me feel uneasy.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "D"
  },
  {
    "id": 15,
    "text": "When I need to make an important decision I just do what seems natural at the moment.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "E"
  },
  {
    "id": 16,
    "text": "I consider all of my options before making a decision.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "A"
  },
  {
    "id": 17,
    "text": "I rely on my inner feelings when making decisions.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "B"
  },
  {
    "id": 18,
    "text": "When I make a decision, I rely on other people's advice.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "C"
  },
  {
    "id": 19,
    "text": "I usually make important decisions at the last minute.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "D"
  },
  {
    "id": 20,
    "text": "I often make impulsive decisions.",
    "options": [
      { "value": 0, "text": "False" },
      { "value": 1, "text": "Sometimes, depending on the situation" },
      { "value": 2, "text": "True" }
    ],
    "weighting": "E"
  }
];

const weightings = {
  "A": "Systemic",
  "B": "Intuitive",
  "C": "Dependent",
  "D": "Avoidant",
  "E": "Spontaneous"
};

let currentQuestion = 0;
let scores = { Systemic: 0, Intuitive: 0, Dependent: 0, Avoidant: 0, Spontaneous: 0 };
let userAnswers = [];

const questionEl = document.getElementById("question");
const choicesEl = document.getElementById("choices");
const quizEl = document.getElementById("quiz");
const resultsEl = document.getElementById("results");
const restartBtn = document.getElementById("restart");
const downloadPDFBtn = document.getElementById("downloadPDF");

function loadQuestion() {
  if (currentQuestion < quizData.length) {
    const question = quizData[currentQuestion];
    questionEl.textContent = question.text;

    choicesEl.innerHTML = "";
    question.options.forEach((option, index) => {
      const button = document.createElement("button");
      button.textContent = option.text;
      button.addEventListener("click", () => selectChoice(index));
      choicesEl.appendChild(button);
    });
  } else {
    showResults();
  }
}

function selectChoice(index) {
  const question = quizData[currentQuestion];
  const selectedOption = question.options[index];

  scores[weightings[question.weighting]] += selectedOption.value;
  userAnswers.push(index);

  currentQuestion++;
  loadQuestion();
}

function showResults() {
  quizEl.style.display = "none";
  resultsEl.style.display = "block";

  const categories = Object.keys(scores);
  const maxScore = 8 * 2; // 4 questions per category, max value of 2 per question
  const categoryScores = categories.map(category => (scores[category] / maxScore) * 100);

  const ctx = document.getElementById('radarChart').getContext('2d');
  new Chart(ctx, {
    type: 'radar',
    data: {
      labels: categories,
      datasets: [{
        label: 'Your General Decision Making Style',
        data: categoryScores,
        backgroundColor: 'rgba(255, 196, 51, 0.2)',
        borderColor: 'rgb(255, 196, 51)',
        pointBackgroundColor: 'rgb(255, 196, 51)',
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: 'rgb(255, 196, 51)'
      }]
    },
    options: {
      elements: {
        line: {
          borderWidth: 3
        }
      },
      scales: {
        r: {
          angleLines: {
            display: false
          },
          suggestedMin: 0,
          suggestedMax: 100
        }
      }
    }
  });
}

function restartQuiz() {
  currentQuestion = 0;
  scores = { Systemic: 0, Intuitive: 0, Dependent: 0, Avoidant: 0, Spontaneous: 0 };
  userAnswers = [];
  quizEl.style.display = "block";
  resultsEl.style.display = "none";
  loadQuestion();
}

function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Add logo to the PDF
  const logoImg = new Image();
  logoImg.src = 'logo.png';
  logoImg.onload = function() {
    const imgWidth = 30;
    const imgHeight = (logoImg.height * imgWidth) / logoImg.width;
    const pageWidth = doc.internal.pageSize.getWidth();
    doc.addImage(logoImg, 'PNG', pageWidth - imgWidth - 10, 10, imgWidth, imgHeight);

    doc.setFontSize(20);
    doc.setFont('Poppins', 'bold');
    doc.text("General Decision Making Style Results", 105, 25, null, null, "center");

    doc.setFontSize(12);
    doc.setFont('Poppins', 'bold');
    let yPos = 40;
    doc.text("Your Decision Style Profile", 20, yPos);
    yPos += 10;

    const categories = Object.keys(scores);
    const maxScore = 8 * 2; // 4 questions per category, max value of 2 per question

    categories.forEach(category => {
      const score = (scores[category] / maxScore) * 100;
      doc.text(`${category}: ${score.toFixed(2)}%`, 30, yPos);
      yPos += 10;
    });

    yPos += 10;
    doc.setFont('Poppins', 'bold');
    doc.text("Decision Descriptions", 20, yPos);
    yPos += 10;
    doc.setFont('Poppins', 'normal');
    doc.setFontSize(10);
    const additionalText = [
      "This quiz assesses your general decision making style based on the standardised GDMS survey.",
      "Rational/systemic: emphasises a thorough search for and logical evaluation of alternatives.",
      "Avoidant: emphasises postponing and avoiding decisions.",
      "Dependent: emphasises a search for advice and direction from others.",
      "Intuitive: emphasises a reliance on hunches and feelings.",
      "Spontaneous: emphasises a sense of immediacy and a desire to get through the decision-making process as soon as possible.",
      "If you have equally high scores in more than one area, it means that you regularly use more than one decision-making style.",
      "Skilled decision-makers are able to use more than one style and in real life most of us do. They're able to be flexible and use the style that best fits the situation."
    ];
    additionalText.forEach(text => {
      doc.text(text, 20, yPos, { maxWidth: 170 });
      yPos += doc.getTextDimensions(text, { maxWidth: 170 }).h + 2;
    });

    html2canvas(document.getElementById("radarChart")).then(canvas => {
      const imgData = canvas.toDataURL("image/png");
      const imgWidth = 100;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      doc.addPage();
      doc.addImage(imgData, "PNG", 15, 20, imgWidth, imgHeight);
      doc.save("GDMS_Results.pdf");

      notifyPDFDownload();
    });
  };
}

function notifyPDFDownload() {
  console.log("Notifying harry@culture-coach.org about PDF download");
  // In a real-world scenario, you would implement an API call here
}

restartBtn.addEventListener("click", restartQuiz);
downloadPDFBtn.addEventListener("click", generatePDF);

loadQuestion();